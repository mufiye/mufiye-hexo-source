---
title: CMU15-445笔记3——Database Storage
date: 2022-06-02 19:35:54
tags: [CMU 15-445, 存储]
categories: 数据库
---

# 1. 数据库系统设计

**数据库系统设计目标：**给应用程序一个错觉，即我们能提供足够的内存将整个数据库存入内存中。

## 1.1 整体的设计架构：

![database-storage-arch](images/database-storage-arch.png)

<center>图1：简单数据库的整体架构</center>

在硬盘中有数据库文件，其由目录和页（也可以说是块）组成；在内存中有一个缓存池，用来缓存数据库文件中的页。当一个运行引擎（查询引擎、执行引擎等）需要得到page 2中的内容，它会向缓冲池发送请求，如果page 2不在缓存池（内存）中，其会在硬盘的page目录中查找page，并将其读取到缓存池中，最后将数据交给运行引擎，运行引擎会对读取到的数据进行相应的操作。

## 1.2 Why Buffer Pool

为什么不依赖操作系统去管理内存，而要额外写一个buffer pool去管理内存呢？用户程序可以使用mmap系统调用让操作系统将文件页面映射到进程的地址空间中，其可以读写该内存页中的内容，操作系统会控制该内存内容，将更改内容写回到硬盘文件中。通过这种方式，操作系统控制了硬盘文件数据在内存中的缓存。

但这会导致一些性能瓶颈，因为操作系统只是从操作系统的层面去考虑控制文件数据在内存中的缓存（如果内存满了，需要换出换入页，那么极有可能换出从DBMS层面来看不该换出的页）。虽然DBMS可以使用madvise告诉操作系统如何访问某些页面（顺序读取还是随即读取），可以使用mlock阻止pages被回收，可以使用msync告诉操作系统要将数据刷出到磁盘中。但是这样仍然可能会遇到性能瓶颈。所以我们要尽可能避免使用操作系统来管理这部分内存，而将这部分工作交给DBMS。

从发展现状来看，大多数主流的数据库比如MySQL、Oracle、DB2以及SQL server都没有使用mmap。当然也有一部分数据库使用了或者部分使用了mmap，前者有levelDB、elasticsearch，后者有SQLite、mongoDB。

# 2. 数据库存储

数据库存储主要关注两个问题，问题1是DBMS如何表示磁盘中文件的数据，问题2是我们实际该如何管理内存以及在硬盘间来回移动数据。

## 2.1 Problem 1

## 2.2 Problem 2
